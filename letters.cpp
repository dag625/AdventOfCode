//
// Created by Daniel Garcia on 12/10/2022.
//

#include "letters.h"
#include "fmt/core.h"

#include <array>
#include <algorithm>
#include <stdexcept>
#include <unordered_map>

namespace aoc {

    namespace {

        struct letter_data_6_by_5 {
            char letter;
            std::array<char, 30> data;
        };

        struct letter_data {
            char letter;
            std::vector<char> data;
        };

        using letter_map = std::vector<letter_data>;

        //The originals
        letter_map LETTERS_4_BY_6 = {{
                                                         {'A', {'.','#','#','#','#','#',    '#','.','.','#','.','.',    '#','.','.','#','.','.',    '.','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                         {'B', {'#','#','#','#','#','#',    '#','.','#','.','.','#',    '#','.','#','.','.','#',    '.','#','.','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'C', {'.','#','#','#','#','.',    '#','.','.','.','.','#',    '#','.','.','.','.','#',    '.','#','.','.','#','.',    '.','.','.','.','.','.'}},
                                                         {'D', {'#','#','#','#','#','#',    '#','.','.','.','.','#',    '#','.','.','.','.','#',    '.','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'E', {'#','#','#','#','#','#',    '#','.','#','.','.','#',    '#','.','#','.','.','#',    '#','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                         {'F', {'#','#','#','#','#','#',    '#','.','#','.','.','.',    '#','.','#','.','.','.',    '#','.','.','.','.','.',    '.','.','.','.','.','.'}},
                                                         {'G', {'.','#','#','#','.','#',    '#','.','.','.','.','#',    '#','.','.','#','.','#',    '.','#','.','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'H', {'#','#','#','#','#','#',    '.','.','#','.','.','.',    '.','.','#','.','.','.',    '#','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                         {'I', {'#','.','.','.','.','.',    '#','#','#','.','.','.',    '#','.','.','#','#','#',    '.','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                         {'J', {'.','.','.','.','#','.',    '.','.','.','.','.','#',    '#','.','.','.','.','#',    '#','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'K', {'#','#','#','#','#','#',    '.','.','#','#','.','.',    '.','#','.','.','#','.',    '#','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                         {'K', {'#','#','#','#','#','#',    '.','.','#','.','.','.',    '.','#','.','#','#','.',    '#','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                         {'L', {'#','#','#','#','#','#',    '.','.','.','.','.','#',    '.','.','.','.','.','#',    '.','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                         {'M', {'#','#','#','#','#','#',    '.','#','#','.','.','.',    '.','#','#','.','.','.',    '#','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                         {'N', {'#','#','#','#','#','#',    '.','#','#','.','.','.',    '.','.','.','#','#','.',    '#','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                         {'O', {'.','#','#','#','#','.',    '#','.','.','.','.','#',    '#','.','.','.','.','#',    '.','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'P', {'#','#','#','#','#','#',    '#','.','.','#','.','.',    '#','.','.','#','.','.',    '.','#','#','.','.','.',    '.','.','.','.','.','.'}},
                                                         {'Q', {'.','#','#','#','#','.',    '#','.','.','.','.','#',    '#','.','.','.','#','#',    '.','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                         {'R', {'#','#','#','#','#','#',    '#','.','.','#','.','.',    '#','.','.','#','#','.',    '.','#','#','.','.','#',    '.','.','.','.','.','.'}},
                                                         {'S', {'.','#','.','.','#','.',    '#','.','.','#','.','#',    '#','.','#','.','.','#',    '.','#','.','.','#','.',    '.','.','.','.','.','.'}},
                                                         {'T', {'#','.','.','.','.','.',    '#','#','#','.','.','.',    '#','.','.','#','#','#',    '#','.','.','.','.','.',    '.','.','.','.','.','.'}},
                                                         {'U', {'#','#','#','#','#','.',    '.','.','.','.','.','#',    '.','.','.','.','.','#',    '#','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'V', {'#','#','#','.','.','.',    '.','.','.','#','#','#',    '.','.','.','#','#','#',    '#','#','#','.','.','.',    '.','.','.','.','.','.'}},
                                                         {'W', {'#','#','#','.','.','.',    '.','.','.','#','#','#',    '.','.','.','#','#','#',    '#','#','#','.','.','.',    '.','.','.','.','.','.'}},
                                                         {'X', {'#','#','.','.','#','#',    '.','.','#','#','.','.',    '.','.','#','#','.','.',    '#','#','.','.','#','#',    '.','.','.','.','.','.'}},
                                                         {'Y', {'#','#','.','.','.','.',    '.','.','#','.','.','.',    '.','.','#','.','.','#',    '#','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                         {'Y', {'#','#','.','.','.','.',    '.','.','#','.','.','.',    '.','.','.','#','#','#',    '.','.','#','.','.','.',    '#','#','.','.','.','.'}},
                                                         {'Z', {'#','.','.','.','#','#',    '#','.','.','#','.','#',    '#','.','#','.','.','#',    '#','#','.','.','.','#',    '.','.','.','.','.','.'}}
                                                 }};

        //Newer ones (name is "LETTERS_W_BY_H", first number is width, second is height).  Note that the top of the characters are at lower indexes.
        letter_map LETTERS_8_BY_10 = {{
                         {'A', {}},
                         {'B', {
                             '#','#','#','#','#','#','#','#','#','#',
                             '#','.','.','.','#','.','.','.','.','#',
                             '#','.','.','.','#','.','.','.','.','#',
                             '#','.','.','.','#','.','.','.','.','#',
                             '#','.','.','.','#','.','.','.','.','#',
                             '.','#','#','#','.','#','#','#','#','.',
                             '.','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.'}},
                         {'C', {}},
                         {'D', {}},
                         {'E', {}},
                         {'F', {
                             '#','#','#','#','#','#','#','#','#','#',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.'}},
                         {'G', {
                             '.','#','#','#','#','#','#','#','#','.',
                             '#','.','.','.','.','.','.','.','.','#',
                             '#','.','.','.','.','.','.','.','.','#',
                             '#','.','.','.','.','#','.','.','.','#',
                             '#','.','.','.','.','#','.','.','#','.',
                             '.','#','.','.','.','#','#','#','#','#',
                             '.','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.'}},
                         {'H', {}},
                         {'I', {}},
                         {'J', {}},
                         {'K', {}},
                         {'L', {
                             '#','#','#','#','#','#','#','#','#','#',
                             '.','.','.','.','.','.','.','.','.','#',
                             '.','.','.','.','.','.','.','.','.','#',
                             '.','.','.','.','.','.','.','.','.','#',
                             '.','.','.','.','.','.','.','.','.','#',
                             '.','.','.','.','.','.','.','.','.','#',
                             '.','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.'}},
                         {'M', {}},
                         {'N', {}},
                         {'O', {}},
                         {'P', {
                             '#','#','#','#','#','#','#','#','#','#',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '.','#','#','#','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.'}},
                         {'Q', {}},
                         {'R', {
                             '#','#','#','#','#','#','#','#','#','#',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','.','.','.','.','.',
                             '#','.','.','.','#','#','.','.','.','.',
                             '#','.','.','.','#','.','#','#','.','.',
                             '.','#','#','#','.','.','.','.','#','#',
                             '.','.','.','.','.','.','.','.','.','.',
                             '.','.','.','.','.','.','.','.','.','.'}},
                         {'S', {}},
                         {'T', {}},
                         {'U', {}},
                         {'V', {}},
                         {'W', {}},
                         {'X', {}},
                         {'Y', {}},
                         {'Z', {}}
                 }};

        using width_map = std::unordered_map<int, const letter_map*>;
        using size_map = std::unordered_map<int, width_map>;

        size_map init_letter_maps() {
            size_map retval;
            retval[4][6] = &LETTERS_4_BY_6;
            retval[8][10] = &LETTERS_8_BY_10;
            return retval;
        }

        const letter_map& get_letter_map(int width, int height) {
            try {
                static const size_map impl = init_letter_maps();
                return *impl.at(width).at(height);
            }
            catch (...) {
                throw std::runtime_error{fmt::format("Failed to find letter map with size {} by {}.", width, height)};
            }
        }

    }

    char to_char(const std::vector<stride_span<const char>>& cols) {
        constexpr std::array<letter_data_6_by_5, 28> LETTERS = {{
                                                 {'A', {'.','#','#','#','#','#',    '#','.','.','#','.','.',    '#','.','.','#','.','.',    '.','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                 {'B', {'#','#','#','#','#','#',    '#','.','#','.','.','#',    '#','.','#','.','.','#',    '.','#','.','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'C', {'.','#','#','#','#','.',    '#','.','.','.','.','#',    '#','.','.','.','.','#',    '.','#','.','.','#','.',    '.','.','.','.','.','.'}},
                                                 {'D', {'#','#','#','#','#','#',    '#','.','.','.','.','#',    '#','.','.','.','.','#',    '.','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'E', {'#','#','#','#','#','#',    '#','.','#','.','.','#',    '#','.','#','.','.','#',    '#','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                 {'F', {'#','#','#','#','#','#',    '#','.','#','.','.','.',    '#','.','#','.','.','.',    '#','.','.','.','.','.',    '.','.','.','.','.','.'}},
                                                 {'G', {'.','#','#','#','.','#',    '#','.','.','.','.','#',    '#','.','.','#','.','#',    '.','#','.','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'H', {'#','#','#','#','#','#',    '.','.','#','.','.','.',    '.','.','#','.','.','.',    '#','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                 {'I', {'#','.','.','.','.','.',    '#','#','#','.','.','.',    '#','.','.','#','#','#',    '.','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                 {'J', {'.','.','.','.','#','.',    '.','.','.','.','.','#',    '#','.','.','.','.','#',    '#','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'K', {'#','#','#','#','#','#',    '.','.','#','#','.','.',    '.','#','.','.','#','.',    '#','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                 {'K', {'#','#','#','#','#','#',    '.','.','#','.','.','.',    '.','#','.','#','#','.',    '#','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                 {'L', {'#','#','#','#','#','#',    '.','.','.','.','.','#',    '.','.','.','.','.','#',    '.','.','.','.','.','#',    '.','.','.','.','.','.'}},
                                                 {'M', {'#','#','#','#','#','#',    '.','#','#','.','.','.',    '.','#','#','.','.','.',    '#','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                 {'N', {'#','#','#','#','#','#',    '.','#','#','.','.','.',    '.','.','.','#','#','.',    '#','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                 {'O', {'.','#','#','#','#','.',    '#','.','.','.','.','#',    '#','.','.','.','.','#',    '.','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'P', {'#','#','#','#','#','#',    '#','.','.','#','.','.',    '#','.','.','#','.','.',    '.','#','#','.','.','.',    '.','.','.','.','.','.'}},
                                                 {'Q', {'.','#','#','#','#','.',    '#','.','.','.','.','#',    '#','.','.','.','#','#',    '.','#','#','#','#','#',    '.','.','.','.','.','.'}},
                                                 {'R', {'#','#','#','#','#','#',    '#','.','.','#','.','.',    '#','.','.','#','#','.',    '.','#','#','.','.','#',    '.','.','.','.','.','.'}},
                                                 {'S', {'.','#','.','.','#','.',    '#','.','.','#','.','#',    '#','.','#','.','.','#',    '.','#','.','.','#','.',    '.','.','.','.','.','.'}},
                                                 {'T', {'#','.','.','.','.','.',    '#','#','#','.','.','.',    '#','.','.','#','#','#',    '#','.','.','.','.','.',    '.','.','.','.','.','.'}},
                                                 {'U', {'#','#','#','#','#','.',    '.','.','.','.','.','#',    '.','.','.','.','.','#',    '#','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'V', {'#','#','#','.','.','.',    '.','.','.','#','#','#',    '.','.','.','#','#','#',    '#','#','#','.','.','.',    '.','.','.','.','.','.'}},
                                                 {'W', {'#','#','#','.','.','.',    '.','.','.','#','#','#',    '.','.','.','#','#','#',    '#','#','#','.','.','.',    '.','.','.','.','.','.'}},
                                                 {'X', {'#','#','.','.','#','#',    '.','.','#','#','.','.',    '.','.','#','#','.','.',    '#','#','.','.','#','#',    '.','.','.','.','.','.'}},
                                                 {'Y', {'#','#','.','.','.','.',    '.','.','#','.','.','.',    '.','.','#','.','.','#',    '#','#','#','#','#','.',    '.','.','.','.','.','.'}},
                                                 {'Y', {'#','#','.','.','.','.',    '.','.','#','.','.','.',    '.','.','.','#','#','#',    '.','.','#','.','.','.',    '#','#','.','.','.','.'}},
                                                 {'Z', {'#','.','.','.','#','#',    '#','.','.','#','.','#',    '#','.','#','.','.','#',    '#','#','.','.','.','#',    '.','.','.','.','.','.'}}
                                         }};
        if (cols.size() != 5 && !std::all_of(cols.begin(), cols.end(), [](const auto& col){ return col.size() == 6; })) { return '\0'; }
        for (const auto& letter : LETTERS) {
            auto current = letter.data.begin();
            bool matches = true;
            for (const auto& col : cols) {
                for (const char c : col) {
                    if (*current != c) {
                        matches = false;
                        break;
                    }
                    ++current;
                }
            }
            if (matches) {
                return letter.letter;
            }
        }
        return  '\0';
    }

    char to_char(const std::vector<stride_span<const char>>& cols, const int char_width, const int char_height) {
        const auto& map = get_letter_map(char_width, char_height);
        if (cols.size() != char_width && !std::all_of(cols.begin(), cols.end(), [char_height](const auto& col){ return col.size() == char_height; })) { return '\0'; }
        for (const auto& letter : map) {
            auto current = letter.data.begin();
            if (current == letter.data.end()) {
                //Unimplemented character
                continue;
            }
            bool matches = true;
            for (const auto& col : cols) {
                for (const char c : col) {
                    if (*current != c) {
                        matches = false;
                        break;
                    }
                    ++current;
                }
                if (!matches) { break; }
            }
            if (matches) {
                return letter.letter;
            }
        }
        return  '\0';
    }

    std::string letters_from_grid(const grid<char>& g) {
        std::string retval;
        for (std::size_t col = 0; col < g.num_cols();) {
            std::vector<stride_span<const char>> cols;
            for (int i = 0; i < 5; ++i, ++col) {
                cols.push_back(g.const_column_span(col));
            }
            const auto c = to_char(cols);
            retval.push_back(c);
        }
        return retval;
    }

    std::string letters_from_grid(const grid<char>& g, const int char_width, const int char_height) {
        std::string retval;
        for (std::size_t col = 0; col < g.num_cols();) {
            std::vector<stride_span<const char>> cols;
            for (int i = 0; i < char_width; ++i, ++col) {
                cols.push_back(g.const_column_span(col));
            }
            const auto c = to_char(cols, char_width, char_height);
            retval.push_back(c);
        }
        return retval;
    }

} /* namespace aoc */